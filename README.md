SpreeAutoRegistration
=====================

reduces the registration step to the bare minimum. The user is going through checkout as a quest. However the order is confirmed, an activation/confirmation link is sent by e-mail to the newly (auto)registered user. Following the link leads to a page where the new user must pick a password to confirm the account.

It was made based on this tutorial with some adjustmets for Spree: https://github.com/plataformatec/devise/wiki/How-To:-Override-confirmations-so-users-can-pick-their-own-passwords-as-part-of-confirmation-activation

In case the user tries to checkout with the email address which was already used for some order before, then is prompted to login on the address step of the checkout. Alternatively, they can use another email address.

This is written for standard Spree::User. Ensure you have following in config/initializers/spree.rb
```ruby
Spree.user_class = "Spree::User"
```

Tested for Sreee *3.3.0.rc1*, but maybe will works also with older versions.

**note: This is one of my first gems ... for my first project with Spree, so please have an understanding if something is not perfect. Your contribution or advice what to improve is very welcome! It works fine for me and it should works for standard purposes, but I do not give any guaranty that it will works with your particular configuration of Spree.**

## Installation

1. Add this extension to your Gemfile with this line:
  ```ruby
  gem 'spree_auto_registration', github: '[your-github-handle]/spree_auto_registration'
  ```

2. Install the gem using Bundler:
  ```ruby
  bundle install
  ```

3. Your app settings:
Add following configuration into config/initializers/devise.rb:
```ruby
Devise.setup do |config|
  # Required so users don't lose their carts when they need to confirm.
  # Definition of the time within which user can confirm their account. (From user point of view it's smoother to make no limits, from security point of view it's probably good to limit it - in case of leak of the confirmation token ... Or maybe some hard attac that will generates random tokens can accidently confirm the someone else's account. This threat can be reduce with proper monitoring. Consider on your own context.)  config.allow_unconfirmed_access_for = 100000.days

  # Fixes the bug where Confirmation errors result in a broken page.
  config.router_name = :spree

  # When you set config.reconfirmable = true in config/initializers/devise.rb than Devise requires any email changes to be confirmed by email. This might be a problem when you want to change email without sending confirmation, for example when admin edits some user.
  config.reconfirmable = false
end
```

Add following configuration into config/initializers/spree.rb:
```ruby
Spree::Auth::Config[:registration_step] = false
Spree::Auth::Config[:confirmable] = true
```

For smooth user flow add into ApplicationController:
```ruby
  before_action :set_return_path
  # go back on the previous page after the login
  def after_sign_in_path_for(resource) 
    session["user_return_to"] || root_url 
  end
  def set_return_path
    unless devise_controller? || request.xhr? || !request.get?
      session["user_return_to"] = request.url
    end
  end
```

4. Restart your server

  If your server was running, restart it so that it can find the assets properly.

## Testing

!!! NO SPECS, YOUR CONTRIBUTION IS VERY WELCOME!

--

First bundle your dependencies, then run `rake`. `rake` will default to building the dummy app if it does not exist, then it will run specs. The dummy app can be regenerated by using `rake test_app`.

```shell
bundle
bundle exec rake
```

When testing your applications integration with this extension you may use it's factories.
Simply add this require statement to your spec_helper:

```ruby
require 'spree_auto_registration/factories'
```


## Contributing

If you'd like to contribute, please take a look at the
[instructions](CONTRIBUTING.md) for installing dependencies and crafting a good
pull request.

Copyright (c) 2017 Josef Hovad / Nobord s.r.o., released under the New BSD License
